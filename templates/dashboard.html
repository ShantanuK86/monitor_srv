<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - isServiceUp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#0d1117', 800: '#161b22', 700: '#21262d', 600: '#30363d' },
                        primary: { 500: '#3b82f6', 600: '#2563eb' }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .file-drop-area { border: 2px dashed #30363d; transition: all 0.3s; }
        .file-drop-area:hover { border-color: #3b82f6; background-color: #161b22; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="bg-dark-900 text-gray-300 min-h-screen flex flex-col pt-24 pb-10 px-4">

    <!-- NAVBAR -->
    <nav class="fixed top-0 left-0 w-full bg-dark-900/95 backdrop-blur-md border-b border-dark-700 z-40">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full border-2 border-green-500 flex items-center justify-center text-green-500 bg-green-500/10"><i class="fas fa-check text-sm"></i></div>
                <div class="flex flex-col">
                    <h1 class="text-lg font-bold tracking-tight text-white leading-tight">isServiceUp</h1>
                    <span class="text-[10px] text-gray-400 font-medium uppercase tracking-wider">IT Department</span>
                </div>
            </div>
            <div class="flex items-center gap-1">
                <a href="/" class="px-4 py-1.5 rounded-full text-gray-400 text-sm font-medium hover:text-white hover:bg-dark-800/50 transition-colors">Services</a>
                <a href="/monitoring" class="px-4 py-1.5 rounded-full text-gray-400 text-sm font-medium hover:text-white hover:bg-dark-800/50 transition-colors">24*7 Monitoring</a>
                <a href="/dashboard" class="px-4 py-1.5 rounded-full bg-dark-800 text-white text-sm font-medium border border-dark-700 hover:bg-dark-700 transition-colors">Dashboard</a>
                <a href="/hardware_list" class="px-4 py-1.5 rounded-full text-gray-400 text-sm font-medium hover:text-white hover:bg-dark-800/50 transition-colors">Hardware List</a>
            </div>
        </div>
    </nav>

    <div class="w-full max-w-7xl mx-auto">
        
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold text-white">Analytics Dashboard</h1>
            {% if records %}
            <button onclick="window.location.href='/dashboard'" class="text-sm text-blue-500 hover:text-blue-400"><i class="fas fa-upload mr-1"></i> Upload New File</button>
            {% endif %}
        </div>

        {% if not records %}
        <div class="bg-dark-800 border border-dark-700 rounded-xl p-12 text-center max-w-2xl mx-auto mt-10">
            <form action="/upload_file" method="post" enctype="multipart/form-data" class="flex flex-col items-center justify-center w-full">
                <div class="mb-6">
                    <div class="w-16 h-16 bg-dark-700 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-cloud-upload-alt text-3xl text-blue-500"></i></div>
                    <h3 class="text-2xl font-bold text-white mb-2">Upload Incident Data</h3>
                    <p class="text-gray-400 text-sm">Required columns: services, state, stage, creationtime, recentreporttime</p>
                </div>
                <label for="file-upload" class="file-drop-area cursor-pointer flex flex-col items-center justify-center w-full h-40 rounded-xl bg-dark-900 hover:bg-dark-800/50 transition-colors group">
                    <span class="text-gray-400 font-medium text-sm group-hover:text-white transition-colors">Click to browse or drag file here</span>
                    <input id="file-upload" name="file" type="file" class="hidden" accept=".csv, .xlsx, .xls" onchange="this.form.submit()">
                </label>
            </form>
            {% with messages = get_flashed_messages() %}
              {% if messages %}
                <div class="mt-6 p-4 bg-red-900/20 border border-red-500/50 rounded-lg text-red-400 text-sm flex items-center justify-center gap-2"><i class="fas fa-exclamation-circle"></i> {{ messages[0] }}</div>
              {% endif %}
            {% endwith %}
        </div>
        {% endif %}

        {% if records %}
        
        <!-- Filters -->
        <div class="bg-dark-800 border border-dark-700 rounded-xl p-4 mb-8 flex flex-wrap items-center gap-4 shadow-lg sticky top-20 z-30 backdrop-blur-sm bg-dark-800/90">
            <div class="relative flex-grow max-w-xs">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="searchInput" placeholder="Search services..." class="bg-dark-900 border border-dark-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5 placeholder-gray-500" oninput="applyFilters()">
            </div>

            <div class="relative">
                <i class="far fa-calendar-alt absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="dateRange" placeholder="Select Time Period" class="bg-dark-900 border border-dark-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-56 pl-10 p-2.5 placeholder-gray-500">
            </div>
            
            <select id="serviceFilter" class="bg-dark-900 border border-dark-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 min-w-[150px]">
                <option value="ALL">All Services</option>
                {% for s in services %}
                <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
            </select>

            <select id="stageFilter" class="bg-dark-900 border border-dark-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 min-w-[120px]">
                <option value="ALL">All Stages</option>
                {% for s in stages %}
                <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
            </select>

            <select id="stateFilter" class="bg-dark-900 border border-dark-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 min-w-[120px]">
                <option value="ALL">All States</option>
                {% for s in states %}
                <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
            </select>

            <button onclick="applyFilters()" class="ml-auto px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors shadow-md">Apply Filters</button>
        </div>

        <!-- Global KPIs (Simplified Layout) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Incidents -->
            <div class="bg-dark-800 border border-dark-700 rounded-xl p-6">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-gray-400 font-medium text-sm">Total Incidents</h3>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-dark-900 border border-dark-600 text-green-400">
                        <i class="fas fa-arrow-up mr-1"></i> +12%
                    </span>
                </div>
                <div class="text-3xl font-bold text-white mb-2" id="kpiTotal">0</div>
                <div class="text-xs text-gray-500">Trending up this month</div>
            </div>

            <!-- Open Issues -->
            <div class="bg-dark-800 border border-dark-700 rounded-xl p-6">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-gray-400 font-medium text-sm">Open Issues</h3>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-dark-900 border border-dark-600 text-red-400">
                        <i class="fas fa-arrow-up mr-1"></i> +5%
                    </span>
                </div>
                <div class="text-3xl font-bold text-white mb-2" id="kpiOpen">0</div>
                <div class="text-xs text-gray-500">Down 20% this period</div>
            </div>

            <!-- Stage Breakdown -->
            <div class="bg-dark-800 border border-dark-700 rounded-xl p-6">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-gray-400 font-medium text-sm">Stage Breakdown</h3>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-dark-900 border border-dark-600 text-white">
                        <i class="fas fa-server mr-1"></i> Env
                    </span>
                </div>
                <div class="flex items-end gap-2 mb-2">
                    <span class="text-2xl font-bold text-white" id="kpiProd">0</span>
                    <span class="text-sm text-gray-500 mb-1">PRD</span>
                    <span class="text-gray-600 mb-1">/</span>
                    <span class="text-xl font-bold text-gray-400" id="kpiStg">0</span>
                    <span class="text-xs text-gray-600 mb-1">STG</span>
                </div>
                <div class="w-full bg-dark-700 h-1.5 rounded-full overflow-hidden mt-1">
                    <div id="kpiStageBar" class="bg-blue-500 h-full rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <!-- Closed Issues -->
            <div class="bg-dark-800 border border-dark-700 rounded-xl p-6">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-gray-400 font-medium text-sm">Closed Issues</h3>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-dark-900 border border-dark-600 text-white">
                        <i class="fas fa-check mr-1"></i> +4.5%
                    </span>
                </div>
                <div class="text-3xl font-bold text-white mb-2" id="kpiClosed">0</div>
                <div class="text-xs text-gray-500">Steady performance</div>
            </div>
        </div>

        <!-- Trend Chart -->
        <div class="bg-dark-800 border border-dark-700 rounded-xl p-6 mb-8">
            <h2 class="text-lg font-bold text-white mb-4">Total Incidents by Service</h2>
            <div class="w-full h-72">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- Service Breakdown Grid -->
        <div class="flex items-center justify-between mb-4 border-b border-dark-700 pb-2">
            <h2 class="text-xl font-bold text-white">Service Breakdown</h2>
            <!-- Pagination Controls -->
            <div class="flex items-center gap-2" id="paginationControls" style="display: none;">
                <span class="text-sm text-gray-400" id="pageInfo">Page 1 of 1</span>
                <button onclick="prevPage()" id="prevBtn" class="px-3 py-1 bg-dark-800 border border-dark-600 text-white rounded hover:bg-dark-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button onclick="nextPage()" id="nextBtn" class="px-3 py-1 bg-dark-800 border border-dark-600 text-white rounded hover:bg-dark-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        
        <div id="serviceCardsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-10">
            <!-- Cards Injected via JS -->
        </div>

        {% endif %}
    </div>

    {% if records %}
    <script>
        const rawData = {{ records | tojson }};
        let chartInstance = null;
        let currentChartView = 'daily'; // Default view (Kept variable but not used in new bar logic)

        // Initialize Flatpickr
        const fp = flatpickr("#dateRange", { 
            mode: "range", 
            dateFormat: "Y-m-d", 
            theme: "dark",
            defaultDate: [new Date().setDate(new Date().getDate() - 30), new Date()], // Default last 30 days
            onChange: function() {
                // Optional: Auto apply if desired, currently button triggered
            }
        });

        // --- Pagination State ---
        let currentPage = 1;
        const itemsPerPage = 8;
        let currentFilteredGroups = []; // Holds the keys (service names) after filtering

        function applyFilters() {
            const dateRange = document.getElementById('dateRange')._flatpickr.selectedDates;
            const serviceVal = document.getElementById('serviceFilter').value;
            const stageVal = document.getElementById('stageFilter').value;
            const stateVal = document.getElementById('stateFilter').value;
            const searchVal = document.getElementById('searchInput').value.toLowerCase();

            const filtered = rawData.filter(row => {
                // Date Filter (Using creationtime for "when it happened")
                if (dateRange.length === 2) {
                    const d = new Date(row.creationtime);
                    const start = new Date(dateRange[0].setHours(0,0,0,0));
                    const end = new Date(dateRange[1].setHours(23,59,59,999));
                    if (d < start || d > end) return false;
                }
                
                // Dropdowns
                if (serviceVal !== 'ALL' && String(row.services).trim() !== serviceVal) return false;
                if (stageVal !== 'ALL' && String(row.stage).trim() !== stageVal) return false;
                if (stateVal !== 'ALL' && String(row.state).trim() !== stateVal) return false;
                
                // Search
                if (searchVal && !String(row.services).toLowerCase().includes(searchVal)) return false;

                return true;
            });

            // Reset page when filtering
            currentPage = 1;
            updateDashboard(filtered);
        }

        function updateDashboard(data) {
            // 1. Update Global KPIs
            const total = data.length;
            const open = data.filter(r => r.state === 'open').length;
            const closed = data.filter(r => r.state === 'closed').length;
            const prod = data.filter(r => r.stage === 'prd').length;
            const stg = data.filter(r => r.stage === 'stg').length;

            animateValue("kpiTotal", parseInt(document.getElementById("kpiTotal").innerText), total, 500);
            animateValue("kpiOpen", parseInt(document.getElementById("kpiOpen").innerText), open, 500);
            animateValue("kpiClosed", parseInt(document.getElementById("kpiClosed").innerText), closed, 500);
            
            // Stage KPI
            document.getElementById("kpiProd").innerText = prod;
            document.getElementById("kpiStg").innerText = stg;
            const prodPct = total > 0 ? (prod / total) * 100 : 0;
            document.getElementById("kpiStageBar").style.width = `${prodPct}%`;

            // 2. Update Chart (Incident Count per Service)
            updateChart(data);

            // 3. Grouping and Trend Logic
            const groups = {};
            const now = new Date();
            const sevenDaysAgo = new Date(); sevenDaysAgo.setDate(now.getDate() - 7);
            const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(now.getDate() - 30);

            data.forEach(r => {
                const svcName = r.services;
                if (!groups[svcName]) {
                    groups[svcName] = { 
                        total: 0, open: 0, inprogress: 0, closed: 0, lastReport: null, lastStatus: 'Unknown',
                        trend7: Array(7).fill(0),
                        trend30: Array(30).fill(0)
                    };
                }
                const g = groups[svcName];
                g.total++;
                if (r.state === 'open') g.open++;
                if (r.state === 'inprogress') g.inprogress++;
                if (r.state === 'closed') g.closed++;

                const creationDate = new Date(r.creationtime);
                
                // Calculate 7-day trend (by day index 0-6)
                if (creationDate >= sevenDaysAgo && creationDate <= now) {
                    const dayDiff = Math.floor((now - creationDate) / (1000 * 60 * 60 * 24));
                    if (dayDiff >= 0 && dayDiff < 7) {
                        g.trend7[6 - dayDiff]++; // Fill from right (today) to left
                    }
                }
                
                // Calculate 30-day trend (by day index 0-29)
                if (creationDate >= thirtyDaysAgo && creationDate <= now) {
                    const dayDiff = Math.floor((now - creationDate) / (1000 * 60 * 60 * 24));
                    if (dayDiff >= 0 && dayDiff < 30) {
                        g.trend30[29 - dayDiff]++;
                    }
                }

                // Track Latest Report Logic
                if (r.recentreporttime) {
                    const d = new Date(r.recentreporttime);
                    if (!g.lastReport || d > g.lastReport) {
                        g.lastReport = d;
                        g.lastStatus = r.state; 
                    }
                }
            });

            // Store for pagination
            currentFilteredGroups = Object.keys(groups).sort().map(key => ({
                name: key,
                stats: groups[key]
            }));

            renderPage();
        }

        function renderPage() {
            const container = document.getElementById('serviceCardsContainer');
            container.innerHTML = '';

            if (currentFilteredGroups.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 italic py-10">No data found matching these filters.</div>';
                document.getElementById('paginationControls').style.display = 'none';
                return;
            }

            // Calculate Slice
            const totalPages = Math.ceil(currentFilteredGroups.length / itemsPerPage);
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageItems = currentFilteredGroups.slice(start, end);

            pageItems.forEach(item => {
                const svc = item.name;
                const s = item.stats;
                const lastStr = s.lastReport ? s.lastReport.toLocaleDateString() + ' ' + s.lastReport.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A';
                
                let borderColor = 'border-dark-700';
                if (s.open > 0) borderColor = 'border-red-500/50';
                else if (s.inprogress > 0) borderColor = 'border-yellow-500/50';

                // Generate dynamic sparklines
                const sparkline7Path = generateSparklinePath(s.trend7, 100, 25);
                // For 30 days, we aggregate slightly to smooth it or just plot all 30 points
                // Simple aggregation: group every 3 days into 1 point for smoothness
                const aggregated30 = aggregateData(s.trend30, 10);
                const sparkline30Path = generateSparklinePath(aggregated30, 100, 25);

                const html = `
                <div class="bg-dark-800 border ${borderColor} rounded-xl p-5 hover:bg-dark-700/50 transition-all shadow-sm group">
                    <div class="flex justify-between items-start mb-4">
                        <div class="text-right w-full">
                            <h3 class="font-bold text-white text-md truncate w-full" title="${svc}">${svc}</h3>
                            <p class="text-[10px] text-gray-500">Updated: ${lastStr}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <div class="text-[10px] text-gray-400 mb-1">Last 7 Days</div>
                            <svg width="100%" height="25" viewBox="0 0 100 25" preserveAspectRatio="none" class="stroke-blue-500 fill-none stroke-2">
                                <path d="${sparkline7Path}" vector-effect="non-scaling-stroke" />
                            </svg>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-gray-400 mb-1">Last 30 Days</div>
                            <svg width="100%" height="25" viewBox="0 0 100 25" preserveAspectRatio="none" class="stroke-purple-500 fill-none stroke-2">
                                <path d="${sparkline30Path}" vector-effect="non-scaling-stroke" />
                            </svg>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 text-center pt-2 border-t border-dark-700/50">
                        <div class="bg-dark-900 rounded p-1">
                            <div class="text-[10px] text-gray-500">Total</div>
                            <div class="text-md font-bold text-white">${s.total}</div>
                        </div>
                        <div class="bg-dark-900 rounded p-1">
                            <div class="text-[10px] text-gray-500">Open</div>
                            <div class="text-md font-bold ${s.open > 0 ? 'text-red-400' : 'text-white'}">${s.open}</div>
                        </div>
                        <div class="bg-dark-900 rounded p-1">
                            <div class="text-[10px] text-gray-500">Closed</div>
                            <div class="text-md font-bold text-green-400">${s.closed}</div>
                        </div>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });

            // Update Pagination UI
            document.getElementById('paginationControls').style.display = 'flex';
            document.getElementById('pageInfo').innerText = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderPage();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(currentFilteredGroups.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderPage();
            }
        }

        function updateChart(data) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // Calculate incidents per service and time to close
            const serviceData = {};
            
            data.forEach(r => {
                if (!serviceData[r.services]) {
                    serviceData[r.services] = { count: 0, timeToClose: [] };
                }
                serviceData[r.services].count++;
                
                // Sample Logic for Time to Close (Assuming 'timetoclosedinminute' column or calculation)
                // For now using mock calculation based on creationtime vs recentreporttime if closed
                if (r.state === 'closed' && r.recentreporttime && r.creationtime) {
                    const start = new Date(r.creationtime);
                    const end = new Date(r.recentreporttime);
                    const diffMins = Math.max(0, Math.round((end - start) / 60000));
                    serviceData[r.services].timeToClose.push(diffMins);
                } else if (r.timetoclosedinminute) {
                     // If explicit column exists (future proofing as requested)
                     serviceData[r.services].timeToClose.push(parseInt(r.timetoclosedinminute) || 0);
                }
            });

            // Sort by count descending
            const sortedServices = Object.keys(serviceData).sort((a,b) => serviceData[b].count - serviceData[a].count);
            // Take top 20
            const topServices = sortedServices.slice(0, 20);
            
            const labels = topServices;
            const incidentCounts = topServices.map(s => serviceData[s].count);
            const avgTimeClose = topServices.map(s => {
                const times = serviceData[s].timeToClose;
                if (times.length === 0) return 0;
                return Math.round(times.reduce((a,b) => a+b, 0) / times.length);
            });

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Incidents',
                            data: incidentCounts,
                            backgroundColor: '#3b82f6',
                            borderRadius: 4,
                            barThickness: 'flex',
                            maxBarThickness: 30,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Avg Time to Close (min)',
                            data: avgTimeClose,
                            backgroundColor: '#10b981', // Green for time
                            borderRadius: 4,
                            barThickness: 'flex',
                            maxBarThickness: 30,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: { 
                        legend: { position: 'top', labels: { color: '#9ca3af' } }, 
                        tooltip: { backgroundColor: '#161b22', borderColor: '#30363d', borderWidth: 1 } 
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: '#30363d' }, 
                            ticks: { color: '#94a3b8' },
                            title: { display: true, text: 'Incident Count', color: '#3b82f6' }
                        },
                        y1: {
                            beginAtZero: true,
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false }, // only want the grid lines for one axis to show up
                            ticks: { color: '#94a3b8' },
                            title: { display: true, text: 'Avg Time (min)', color: '#10b981' }
                        },
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#94a3b8', autoSkip: false, maxRotation: 45, minRotation: 45 } 
                        }
                    }
                }
            });
        }

        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            const obj = document.getElementById(id);
            const timer = setInterval(function() {
                current += increment;
                obj.innerHTML = current;
                if (current == end) clearInterval(timer);
            }, Math.max(stepTime, 10));
        }

        // --- Sparkline Helpers ---
        function generateSparklinePath(data, width, height) {
            if (data.length === 0) return "";
            const maxVal = Math.max(...data, 1); 
            const stepX = width / (data.length - 1);
            
            let path = `M0 ${height - (data[0] / maxVal * height)}`;
            for (let i = 1; i < data.length; i++) {
                const x = i * stepX;
                const y = height - (data[i] / maxVal * height);
                path += ` L${x} ${y}`;
            }
            return path;
        }

        function aggregateData(data, numPoints) {
            const aggregated = [];
            const chunkSize = Math.ceil(data.length / numPoints);
            for (let i = 0; i < data.length; i += chunkSize) {
                const chunk = data.slice(i, i + chunkSize);
                const sum = chunk.reduce((a, b) => a + b, 0);
                aggregated.push(sum);
            }
            return aggregated;
        }

        // Trigger initial load
        applyFilters();
    </script>
    {% endif %}

</body>
</html>