<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - isServiceUp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#0d1117', 800: '#161b22', 700: '#21262d', 600: '#30363d' },
                        primary: { 500: '#3b82f6', 600: '#2563eb' }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Date Adapter for Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .file-drop-area { border: 2px dashed #30363d; transition: all 0.3s; }
        .file-drop-area:hover { border-color: #3b82f6; background-color: #161b22; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Sub-service Modal Animation */
        .modal { opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.95); transition: transform 0.3s ease; }
        .modal.active .modal-content { transform: scale(1); }
    </style>
</head>
<body class="bg-dark-900 text-gray-300 min-h-screen flex flex-col pt-24 pb-10 px-4">

    <!-- NAVBAR -->
    <nav class="fixed top-0 left-0 w-full bg-dark-900/95 backdrop-blur-md border-b border-dark-700 z-40">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full border-2 border-green-500 flex items-center justify-center text-green-500 bg-green-500/10"><i class="fas fa-check text-sm"></i></div>
                <div class="flex flex-col">
                    <h1 class="text-lg font-bold tracking-tight text-white leading-tight">isServiceUp</h1>
                    <span class="text-[10px] text-gray-400 font-medium uppercase tracking-wider">IT Department</span>
                </div>
            </div>
            <div class="flex items-center gap-1">
                <a href="/" class="px-4 py-1.5 rounded-full text-gray-400 text-sm font-medium hover:text-white hover:bg-dark-800/50 transition-colors">Services</a>
                <a href="/monitoring" class="px-4 py-1.5 rounded-full text-gray-400 text-sm font-medium hover:text-white hover:bg-dark-800/50 transition-colors">24*7 Monitoring</a>
                <a href="/dashboard" class="px-4 py-1.5 rounded-full bg-dark-800 text-white text-sm font-medium border border-dark-700 hover:bg-dark-700 transition-colors">Dashboard</a>
                <a href="/hardware_list" class="px-4 py-1.5 rounded-full text-gray-400 text-sm font-medium hover:text-white hover:bg-dark-800/50 transition-colors">Hardware List</a>
            </div>
        </div>
    </nav>

    <div class="w-full max-w-7xl mx-auto">
        
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold text-white">Analytics Dashboard</h1>
            {% if records %}
            <button onclick="window.location.href='/dashboard'" class="text-sm text-blue-500 hover:text-blue-400"><i class="fas fa-upload mr-1"></i> Upload New File</button>
            {% endif %}
        </div>

        {% if not records %}
        <div class="bg-dark-800 border border-dark-700 rounded-xl p-12 text-center max-w-2xl mx-auto mt-10">
            <form action="/upload_file" method="post" enctype="multipart/form-data" class="flex flex-col items-center justify-center w-full">
                <div class="mb-6">
                    <div class="w-16 h-16 bg-dark-700 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-cloud-upload-alt text-3xl text-blue-500"></i></div>
                    <h3 class="text-2xl font-bold text-white mb-2">Upload Incident Data</h3>
                    <p class="text-gray-400 text-sm">Required columns: services, state, stage, creationtime, recentreporttime</p>
                </div>
                <label for="file-upload" class="file-drop-area cursor-pointer flex flex-col items-center justify-center w-full h-40 rounded-xl bg-dark-900 hover:bg-dark-800/50 transition-colors group">
                    <span class="text-gray-400 font-medium text-sm group-hover:text-white transition-colors">Click to browse or drag file here</span>
                    <input id="file-upload" name="file" type="file" class="hidden" accept=".csv, .xlsx, .xls" onchange="this.form.submit()">
                </label>
            </form>
            {% with messages = get_flashed_messages() %}
              {% if messages %}
                <div class="mt-6 p-4 bg-red-900/20 border border-red-500/50 rounded-lg text-red-400 text-sm flex items-center justify-center gap-2"><i class="fas fa-exclamation-circle"></i> {{ messages[0] }}</div>
              {% endif %}
            {% endwith %}
        </div>
        {% endif %}

        {% if records %}
        
        <!-- Filters -->
        <div class="bg-dark-800 border border-dark-700 rounded-xl p-4 mb-8 flex flex-wrap items-center gap-4 shadow-lg sticky top-20 z-30 backdrop-blur-sm bg-dark-800/90">
            <div class="relative flex-grow max-w-xs">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="searchInput" placeholder="Search services..." class="bg-dark-900 border border-dark-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5 placeholder-gray-500" oninput="applyFilters()">
            </div>

            <div class="relative">
                <i class="far fa-calendar-alt absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="dateRange" placeholder="Select Time Period" class="bg-dark-900 border border-dark-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-56 pl-10 p-2.5 placeholder-gray-500">
            </div>
            
            <select id="serviceFilter" class="bg-dark-900 border border-dark-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 min-w-[150px]">
                <option value="ALL">All Services</option>
                {% for s in services %}
                <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
            </select>

            <select id="stageFilter" class="bg-dark-900 border border-dark-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 min-w-[120px]">
                <option value="ALL">All Stages</option>
                {% for s in stages %}
                <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
            </select>

            <select id="stateFilter" class="bg-dark-900 border border-dark-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 min-w-[120px]">
                <option value="ALL">All States</option>
                {% for s in states %}
                <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
            </select>

            <button onclick="applyFilters()" class="ml-auto px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors shadow-md">Apply Filters</button>
        </div>

        <!-- Global KPIs (Simple Style) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Incidents -->
            <div class="bg-dark-800 border border-dark-700 rounded-xl p-6">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-gray-400 font-medium text-sm">Total Alerts</h3>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-dark-900 border border-dark-600 text-green-400">
                        <i class="fas fa-arrow-up mr-1"></i> +12%
                    </span>
                </div>
                <div class="text-3xl font-bold text-white mb-2" id="kpiTotal">0</div>
            </div>

            <!-- Open Issues -->
            <div class="bg-dark-800 border border-dark-700 rounded-xl p-6">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-gray-400 font-medium text-sm">Current Open</h3>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-dark-900 border border-dark-600 text-red-400">
                        <i class="fas fa-exclamation-circle mr-1"></i> Active
                    </span>
                </div>
                <div class="text-3xl font-bold text-white mb-2" id="kpiOpen">0</div>
            </div>

            <!-- Stage Breakdown -->
            <div class="bg-dark-800 border border-dark-700 rounded-xl p-6">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-gray-400 font-medium text-sm">Stage Breakdown</h3>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-dark-900 border border-dark-600 text-blue-400">
                        <i class="fas fa-server mr-1"></i> Env
                    </span>
                </div>
                <div class="flex items-end gap-2 mb-2">
                    <span class="text-2xl font-bold text-white" id="kpiProd">0</span>
                    <span class="text-sm text-gray-500 mb-1">PRD</span>
                    <span class="text-gray-600 mb-1">/</span>
                    <span class="text-xl font-bold text-gray-400" id="kpiStg">0</span>
                    <span class="text-xs text-gray-600 mb-1">STG</span>
                </div>
                <div class="w-full bg-dark-700 h-1.5 rounded-full overflow-hidden mt-1">
                    <div id="kpiStageBar" class="bg-blue-500 h-full rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <!-- In Progress Issues -->
            <div class="bg-dark-800 border border-dark-700 rounded-xl p-6">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-gray-400 font-medium text-sm">In Progress</h3>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-dark-900 border border-dark-600 text-yellow-400">
                        <i class="fas fa-tools mr-1"></i> Active
                    </span>
                </div>
                <div class="text-3xl font-bold text-white mb-2" id="kpiInProgress">0</div>
            </div>
        </div>

        <!-- Trend Chart -->
        <div class="bg-dark-800 border border-dark-700 rounded-xl p-6 mb-8">
            <h2 class="text-lg font-bold text-white mb-4">Alerts Over Time</h2>
            <div class="w-full h-72">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- Service Breakdown Grid -->
        <div class="flex items-center justify-between mb-4 border-b border-dark-700 pb-2">
            <h2 class="text-xl font-bold text-white">Service Breakdown</h2>
            <!-- Pagination Controls -->
            <div class="flex items-center gap-2" id="paginationControls" style="display: none;">
                <span class="text-sm text-gray-400" id="pageInfo">Page 1 of 1</span>
                <button onclick="prevPage()" id="prevBtn" class="px-3 py-1 bg-dark-800 border border-dark-600 text-white rounded hover:bg-dark-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button onclick="nextPage()" id="nextBtn" class="px-3 py-1 bg-dark-800 border border-dark-600 text-white rounded hover:bg-dark-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        
        <div id="serviceCardsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-10">
            <!-- Cards Injected via JS -->
        </div>

        {% endif %}
    </div>

    <!-- Sub-service Modal -->
    <div id="subServiceModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
        <div class="modal-content bg-dark-800 border border-dark-700 rounded-xl w-full max-w-3xl shadow-2xl relative overflow-hidden">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-white" id="modalTitle">Service Details</h3>
                    <button onclick="closeSubServiceModal()" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
                
                <!-- Chart Container -->
                <div class="bg-dark-900 p-4 rounded-lg mb-6">
                    <h4 class="text-sm font-bold text-gray-400 mb-4">Weekly Incident Trend (Last 3 Months)</h4>
                    <div class="w-full h-64">
                        <canvas id="serviceWeeklyChart"></canvas>
                    </div>
                </div>

                <h4 class="text-sm font-bold text-gray-400 mb-2">Related Services</h4>
                <div class="space-y-3 max-h-[30vh] overflow-y-auto" id="subServiceList">
                    <!-- Sub-services injected here -->
                </div>
            </div>
            <div class="bg-dark-900 p-4 border-t border-dark-700 text-right">
                <button onclick="closeSubServiceModal()" class="px-4 py-2 bg-dark-700 text-white text-sm font-medium rounded hover:bg-dark-600 transition-colors">Close</button>
            </div>
        </div>
    </div>

    {% if records %}
    <script>
        const rawData = {{ records | tojson }};
        let chartInstance = null;
        let serviceChartInstance = null;

        // Initialize Flatpickr with Time Picker
        const fp = flatpickr("#dateRange", { 
            mode: "range", 
            dateFormat: "Y-m-d H:i", 
            enableTime: true,
            time_24hr: true,
            theme: "dark",
            defaultDate: [new Date().setDate(new Date().getDate() - 30), new Date()],
            onChange: function() {
                // Optional: Auto apply if desired
            }
        });

        // --- Pagination State ---
        let currentPage = 1;
        const itemsPerPage = 8;
        let currentFilteredGroups = []; 

        function applyFilters() {
            const dateRange = document.getElementById('dateRange')._flatpickr.selectedDates;
            const serviceVal = document.getElementById('serviceFilter').value;
            const stageVal = document.getElementById('stageFilter').value;
            const stateVal = document.getElementById('stateFilter').value;
            const searchVal = document.getElementById('searchInput').value.toLowerCase();

            const filtered = rawData.filter(row => {
                // Date Filter
                if (dateRange.length === 2) {
                    const d = new Date(row.creationtime);
                    if (d < dateRange[0] || d > dateRange[1]) return false;
                }
                
                // Dropdowns
                if (serviceVal !== 'ALL' && String(row.services).trim() !== serviceVal) return false;
                if (stageVal !== 'ALL' && String(row.stage).trim() !== stageVal) return false;
                if (stateVal !== 'ALL' && String(row.state).trim() !== stateVal) return false;
                
                // Search
                if (searchVal && !String(row.services).toLowerCase().includes(searchVal)) return false;

                return true;
            });

            currentPage = 1;
            updateDashboard(filtered);
        }

        function updateDashboard(data) {
            const serviceGroups = {};
            const now = new Date();
            const sevenDaysAgo = new Date(); sevenDaysAgo.setDate(now.getDate() - 7);
            const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(now.getDate() - 30);

            let totalAlerts = 0;
            let prdAlerts = 0;
            let stgAlerts = 0;

            data.forEach(r => {
                totalAlerts++;
                if (r.stage === 'prd') prdAlerts++;
                if (r.stage === 'stg') stgAlerts++;

                const svcName = r.services;
                if (!serviceGroups[svcName]) {
                    serviceGroups[svcName] = { 
                        total: 0, 
                        latestRecord: null,
                        alertsOpen: 0,
                        alertsClosed: 0,
                        trend7: Array(7).fill(0),
                        trend30: Array(30).fill(0)
                    };
                }
                const g = serviceGroups[svcName];
                g.total++;
                if (r.state === 'open') g.alertsOpen++;
                if (r.state === 'closed') g.alertsClosed++;

                // Track Latest Report
                if (r.recentreporttime) {
                    const d = new Date(r.recentreporttime);
                    if (!g.latestRecord || d > new Date(g.latestRecord.recentreporttime)) {
                        g.latestRecord = r;
                    }
                }

                // Trend Calc
                const creationDate = new Date(r.creationtime);
                if (creationDate >= sevenDaysAgo && creationDate <= now) {
                    const dayDiff = Math.floor((now - creationDate) / (1000 * 60 * 60 * 24));
                    if (dayDiff >= 0 && dayDiff < 7) g.trend7[6 - dayDiff]++;
                }
                if (creationDate >= thirtyDaysAgo && creationDate <= now) {
                    const dayDiff = Math.floor((now - creationDate) / (1000 * 60 * 60 * 24));
                    if (dayDiff >= 0 && dayDiff < 30) g.trend30[29 - dayDiff]++;
                }
            });

            // Calculate Service-Level KPIs
            let servicesOpen = 0;
            let servicesInProgress = 0;
            let servicesClosed = 0;

            Object.values(serviceGroups).forEach(g => {
                if (g.latestRecord) {
                    if (g.latestRecord.state === 'open') servicesOpen++;
                    else if (g.latestRecord.state === 'inprogress') servicesInProgress++;
                    else if (g.latestRecord.state === 'closed') servicesClosed++;
                }
            });

            animateValue("kpiTotal", parseInt(document.getElementById("kpiTotal").innerText), totalAlerts, 500);
            animateValue("kpiOpen", parseInt(document.getElementById("kpiOpen").innerText), servicesOpen, 500); 
            animateValue("kpiInProgress", parseInt(document.getElementById("kpiInProgress").innerText), servicesInProgress, 500); 
            animateValue("kpiClosed", parseInt(document.getElementById("kpiClosed").innerText), servicesClosed, 500);

            document.getElementById("kpiProd").innerText = prdAlerts;
            document.getElementById("kpiStg").innerText = stgAlerts;
            const prodPct = totalAlerts > 0 ? (prdAlerts / totalAlerts) * 100 : 0;
            document.getElementById("kpiStageBar").style.width = `${prodPct}%`;

            updateChart(data);

            currentFilteredGroups = Object.keys(serviceGroups).sort().map(key => ({
                name: key,
                stats: serviceGroups[key]
            }));

            renderPage();
        }

        function renderPage() {
            const container = document.getElementById('serviceCardsContainer');
            container.innerHTML = '';

            if (currentFilteredGroups.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 italic py-10">No data found matching these filters.</div>';
                document.getElementById('paginationControls').style.display = 'none';
                return;
            }

            const totalPages = Math.ceil(currentFilteredGroups.length / itemsPerPage);
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageItems = currentFilteredGroups.slice(start, end);

            pageItems.forEach(item => {
                const svc = item.name;
                const s = item.stats;
                const latest = s.latestRecord;
                
                let lastStr = 'N/A';
                let currentState = 'Unknown';
                if (latest) {
                    const d = new Date(latest.recentreporttime);
                    lastStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    currentState = latest.state;
                }
                
                let borderColor = 'border-dark-700';
                if (currentState === 'open') borderColor = 'border-red-500/50';
                else if (currentState === 'inprogress') borderColor = 'border-yellow-500/50';

                const sparkline7Path = generateSparklinePath(s.trend7, 100, 25);
                const aggregated30 = aggregateData(s.trend30, 10);
                const sparkline30Path = generateSparklinePath(aggregated30, 100, 25);

                const html = `
                <div class="bg-dark-800 border ${borderColor} rounded-xl p-5 hover:bg-dark-700/50 transition-all shadow-sm group cursor-pointer" onclick="openSubServiceModal('${svc}')">
                    <div class="flex justify-between items-start mb-4">
                        <div class="text-right w-full">
                            <h3 class="font-bold text-white text-md truncate w-full" title="${svc}">${svc}</h3>
                            <p class="text-[10px] text-gray-500">Last Report: ${lastStr}</p>
                            <span class="text-[10px] uppercase font-bold tracking-wider ${currentState === 'open' ? 'text-red-400' : (currentState === 'inprogress' ? 'text-yellow-400' : 'text-green-400')}">${currentState}</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <div class="text-[10px] text-gray-400 mb-1">Last 7 Days</div>
                            <svg width="100%" height="25" viewBox="0 0 100 25" preserveAspectRatio="none" class="stroke-blue-500 fill-none stroke-2">
                                <path d="${sparkline7Path}" vector-effect="non-scaling-stroke" />
                            </svg>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-gray-400 mb-1">Last 30 Days</div>
                            <svg width="100%" height="25" viewBox="0 0 100 25" preserveAspectRatio="none" class="stroke-purple-500 fill-none stroke-2">
                                <path d="${sparkline30Path}" vector-effect="non-scaling-stroke" />
                            </svg>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 text-center pt-2 border-t border-dark-700/50">
                        <div class="bg-dark-900 rounded p-1">
                            <div class="text-[10px] text-gray-500">Total</div>
                            <div class="text-md font-bold text-white">${s.total}</div>
                        </div>
                        <div class="bg-dark-900 rounded p-1">
                            <div class="text-[10px] text-gray-500">Open</div>
                            <div class="text-md font-bold ${s.alertsOpen > 0 ? 'text-red-400' : 'text-white'}">${s.alertsOpen}</div>
                        </div>
                        <div class="bg-dark-900 rounded p-1">
                            <div class="text-[10px] text-gray-500">Closed</div>
                            <div class="text-md font-bold text-green-400">${s.alertsClosed}</div>
                        </div>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });

            document.getElementById('paginationControls').style.display = 'flex';
            document.getElementById('pageInfo').innerText = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }

        function prevPage() { if (currentPage > 1) { currentPage--; renderPage(); } }
        function nextPage() { if (currentPage < Math.ceil(currentFilteredGroups.length / itemsPerPage)) { currentPage++; renderPage(); } }

        function updateChart(data) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            const serviceData = {};
            
            data.forEach(r => {
                if (!serviceData[r.services]) {
                    serviceData[r.services] = { count: 0, timeToClose: [] };
                }
                serviceData[r.services].count++;
                
                if (r.state === 'closed' && r.recentreporttime && r.creationtime) {
                    const start = new Date(r.creationtime);
                    const end = new Date(r.recentreporttime);
                    const diffMins = Math.max(0, Math.round((end - start) / 60000));
                    serviceData[r.services].timeToClose.push(diffMins);
                } else if (r.timetoclosedinminute) {
                     serviceData[r.services].timeToClose.push(parseInt(r.timetoclosedinminute) || 0);
                }
            });

            const sortedServices = Object.keys(serviceData).sort((a,b) => serviceData[b].count - serviceData[a].count);
            const topServices = sortedServices.slice(0, 20);
            
            const labels = topServices;
            const incidentCounts = topServices.map(s => serviceData[s].count);
            const avgTimeClose = topServices.map(s => {
                const times = serviceData[s].timeToClose;
                if (times.length === 0) return 0;
                return Math.round(times.reduce((a,b) => a+b, 0) / times.length);
            });

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Incidents',
                            data: incidentCounts,
                            backgroundColor: '#3b82f6',
                            borderRadius: 4,
                            barThickness: 'flex',
                            maxBarThickness: 30,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Avg Time to Close (min)',
                            data: avgTimeClose,
                            backgroundColor: '#10b981',
                            borderRadius: 4,
                            barThickness: 'flex',
                            maxBarThickness: 30,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { 
                        legend: { position: 'top', labels: { color: '#9ca3af' } }, 
                        tooltip: { backgroundColor: '#161b22', borderColor: '#30363d', borderWidth: 1 } 
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: '#30363d' }, 
                            ticks: { color: '#94a3b8' },
                            title: { display: true, text: 'Incident Count', color: '#3b82f6' }
                        },
                        y1: {
                            beginAtZero: true,
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#94a3b8' },
                            title: { display: true, text: 'Avg Time (min)', color: '#10b981' }
                        },
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#94a3b8', autoSkip: false, maxRotation: 45, minRotation: 45 } 
                        }
                    }
                }
            });
        }

        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            const obj = document.getElementById(id);
            const timer = setInterval(function() {
                current += increment;
                obj.innerHTML = current;
                if (current == end) clearInterval(timer);
            }, Math.max(stepTime, 10));
        }

        function generateSparklinePath(data, width, height) {
            if (data.length === 0) return "";
            const maxVal = Math.max(...data, 1); 
            const stepX = width / (data.length - 1);
            let path = `M0 ${height - (data[0] / maxVal * height)}`;
            for (let i = 1; i < data.length; i++) {
                const x = i * stepX;
                const y = height - (data[i] / maxVal * height);
                path += ` L${x} ${y}`;
            }
            return path;
        }

        function aggregateData(data, numPoints) {
            const aggregated = [];
            const chunkSize = Math.ceil(data.length / numPoints);
            for (let i = 0; i < data.length; i += chunkSize) {
                const chunk = data.slice(i, i + chunkSize);
                const sum = chunk.reduce((a, b) => a + b, 0);
                aggregated.push(sum);
            }
            return aggregated;
        }

        // --- SUB SERVICE MODAL LOGIC ---
        const subServiceModal = document.getElementById('subServiceModal');
        
        function openSubServiceModal(serviceName) {
            document.getElementById('modalTitle').innerText = `${serviceName} - Weekly Trend`;
            const listContainer = document.getElementById('subServiceList');
            listContainer.innerHTML = '';

            // Filter data for this service
            const serviceData = rawData.filter(r => r.services === serviceName);
            
            // --- WEEKLY AGGREGATION ---
            const now = new Date();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(now.getMonth() - 3);
            
            const weeklyCounts = {};
            
            serviceData.forEach(r => {
                const d = new Date(r.creationtime);
                if (d >= threeMonthsAgo && d <= now) {
                    // Get week start (Sunday)
                    const day = d.getDay();
                    const diff = d.getDate() - day;
                    const weekStart = new Date(d);
                    weekStart.setDate(diff);
                    weekStart.setHours(0,0,0,0);
                    
                    const key = weekStart.toLocaleDateString();
                    weeklyCounts[key] = (weeklyCounts[key] || 0) + 1;
                }
            });

            // Prepare Chart Data
            const sortedWeeks = Object.keys(weeklyCounts).sort((a,b) => new Date(a) - new Date(b));
            const counts = sortedWeeks.map(k => weeklyCounts[k]);

            // Render Chart
            const ctx = document.getElementById('serviceWeeklyChart').getContext('2d');
            if (serviceChartInstance) serviceChartInstance.destroy();

            serviceChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedWeeks,
                    datasets: [{
                        label: 'Weekly Incidents',
                        data: counts,
                        backgroundColor: '#3b82f6',
                        borderRadius: 4,
                        barThickness: 'flex',
                        maxBarThickness: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { backgroundColor: '#161b22' } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#30363d' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    }
                }
            });

            // Dummy Sub-services (Generic generation for demo)
            const subServices = [
                { name: 'API Gateway', status: 'Operational', icon: 'fas fa-network-wired' },
                { name: 'Database Cluster', status: 'Operational', icon: 'fas fa-database' },
                { name: 'Web Front-end', status: 'Operational', icon: 'fas fa-laptop-code' },
                { name: 'Background Workers', status: 'Maintenance', icon: 'fas fa-cogs' },
                { name: 'CDN', status: 'Operational', icon: 'fas fa-globe' }
            ];

            subServices.forEach((sub, idx) => {
                let statusClass = 'text-green-400 bg-green-900/20 border-green-900/40';
                if (sub.status === 'Maintenance') statusClass = 'text-blue-400 bg-blue-900/20 border-blue-900/40';
                if (idx === 3 && Math.random() > 0.5) {
                     sub.status = 'Degraded Performance';
                     statusClass = 'text-yellow-400 bg-yellow-900/20 border-yellow-900/40';
                }

                const itemHTML = `
                <div class="flex items-center justify-between p-3 bg-dark-900 rounded-lg border border-dark-700 hover:bg-dark-700 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded bg-dark-800 flex items-center justify-center text-gray-400">
                            <i class="${sub.icon}"></i>
                        </div>
                        <span class="text-gray-200 font-medium text-sm">${serviceName} ${sub.name} ${idx+1}</span>
                    </div>
                    <span class="text-xs font-bold px-2 py-1 rounded border ${statusClass}">
                        ${sub.status}
                    </span>
                </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', itemHTML);
            });

            subServiceModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSubServiceModal() {
            subServiceModal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Close on outside click
        subServiceModal.addEventListener('click', (e) => {
            if (e.target === subServiceModal) closeSubServiceModal();
        });

        applyFilters();
    </script>
    {% endif %}

</body>
</html>