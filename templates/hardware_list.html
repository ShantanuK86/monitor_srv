<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hardware List - isServiceUp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#0d1117', 800: '#161b22', 700: '#21262d', 600: '#30363d' },
                        primary: { 500: '#3b82f6', 600: '#2563eb' }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .file-drop-area { border: 2px dashed #30363d; transition: all 0.3s; }
        .file-drop-area:hover { border-color: #3b82f6; background-color: #161b22; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .hw-table th { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #9ca3af; padding: 1rem; border-bottom: 1px solid #30363d; text-align: left; white-space: nowrap; }
        .hw-table td { padding: 1rem; border-bottom: 1px solid #21262d; color: #e5e7eb; font-size: 0.875rem; vertical-align: middle; white-space: nowrap; }
        .hw-table tr:hover { background-color: #1c2128; }
        .checkbox-custom { appearance: none; width: 1.25rem; height: 1.25rem; border: 2px solid #4b5563; border-radius: 0.25rem; background-color: transparent; cursor: pointer; position: relative; }
        .checkbox-custom:checked { background-color: #3b82f6; border-color: #3b82f6; }
        .checkbox-custom:checked::after { content: '\f00c'; font-family: 'Font Awesome 5 Free'; font-weight: 900; color: white; font-size: 0.75rem; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        /* Column Visibility Dropdown */
        .col-dropdown { position: relative; }
        .col-menu { position: absolute; right: 0; top: 100%; width: 200px; max-height: 300px; overflow-y: auto; background: #161b22; border: 1px solid #30363d; border-radius: 6px; z-index: 50; display: none; margin-top: 4px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        .col-menu.open { display: block; }
        .col-option { display: flex; align-items: center; padding: 8px 12px; cursor: pointer; color: #c9d1d9; font-size: 0.85rem; }
        .col-option:hover { background: #21262d; }
        .col-option input { margin-right: 10px; }
        
        .hidden-col { display: none !important; }
        
        /* Action Menu */
        .action-menu { position: absolute; right: 40px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; z-index: 40; display: none; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); width: 120px; }
        .action-menu.open { display: block; }
        .action-item { padding: 8px 12px; font-size: 0.8rem; color: #c9d1d9; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .action-item:hover { background: #21262d; color: white; }
        .action-item.delete { color: #f87171; }
        .action-item.delete:hover { background: rgba(239, 68, 68, 0.1); }
        
        .edit-input { background: #0d1117; border: 1px solid #3b82f6; color: white; padding: 4px 8px; width: 100%; border-radius: 4px; font-size: 0.875rem; }
    </style>
</head>
<body class="bg-dark-900 text-gray-300 min-h-screen flex flex-col pt-24 pb-10 px-4">

    <!-- NAVBAR -->
    <nav class="fixed top-0 left-0 w-full bg-dark-900/95 backdrop-blur-md border-b border-dark-700 z-40">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full border-2 border-green-500 flex items-center justify-center text-green-500 bg-green-500/10"><i class="fas fa-check text-sm"></i></div>
                <div class="flex flex-col">
                    <h1 class="text-lg font-bold tracking-tight text-white leading-tight">isServiceUp</h1>
                    <span class="text-[10px] text-gray-400 font-medium uppercase tracking-wider">IT Department</span>
                </div>
            </div>
            <div class="flex items-center gap-1">
                <a href="/" class="px-4 py-1.5 rounded-full text-gray-400 text-sm font-medium hover:text-white hover:bg-dark-800/50 transition-colors">Services</a>
                <a href="/monitoring" class="px-4 py-1.5 rounded-full text-gray-400 text-sm font-medium hover:text-white hover:bg-dark-800/50 transition-colors">24*7 Monitoring</a>
                <a href="/dashboard" class="px-4 py-1.5 rounded-full text-gray-400 text-sm font-medium hover:text-white hover:bg-dark-800/50 transition-colors">Dashboard</a>
                <a href="/hardware_list" class="px-4 py-1.5 rounded-full bg-dark-800 text-white text-sm font-medium border border-dark-700 hover:bg-dark-700 transition-colors">Hardware List</a>
            </div>
        </div>
    </nav>

    <div class="w-full max-w-7xl mx-auto">
        
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold text-white">Hardware Inventory</h1>
            <div class="flex items-center gap-4">
                <span class="text-xs text-gray-500">Source: {{ filename }}</span>
                <button onclick="document.getElementById('upload-modal').classList.remove('hidden')" class="text-sm text-blue-500 hover:text-blue-400"><i class="fas fa-upload mr-1"></i> Upload New</button>
            </div>
        </div>

        <!-- Hidden Upload Modal -->
        <div id="upload-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
            <div class="bg-dark-800 border border-dark-700 rounded-xl p-8 max-w-md w-full relative">
                <button onclick="document.getElementById('upload-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                <form action="/upload_hardware_file" method="post" enctype="multipart/form-data" class="flex flex-col items-center justify-center w-full">
                    <div class="mb-4 text-center">
                        <i class="fas fa-server text-3xl text-blue-500 mb-2"></i>
                        <h3 class="text-xl font-bold text-white">Upload New List</h3>
                    </div>
                    <label for="file-upload" class="file-drop-area cursor-pointer flex flex-col items-center justify-center w-full h-32 rounded-xl bg-dark-900 hover:bg-dark-800/50 transition-colors group">
                        <span class="text-gray-400 font-medium text-sm group-hover:text-white transition-colors">Select CSV/Excel File</span>
                        <input id="file-upload" name="file" type="file" class="hidden" accept=".csv, .xlsx, .xls" onchange="this.form.submit()">
                    </label>
                </form>
            </div>
        </div>

        {% if records %}
        
        <!-- Controls Bar -->
        <div class="bg-dark-800 border border-dark-700 rounded-t-xl p-4 flex flex-wrap items-center justify-between gap-4">
            
            <!-- Search -->
            <div class="relative flex-grow max-w-md">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="searchInput" placeholder="Search inventory..." class="bg-dark-900 border border-dark-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5 placeholder-gray-500" oninput="applySearch()">
            </div>
            
            <div class="flex items-center gap-3">
                <span class="text-sm text-gray-400" id="recordCount">{{ records|length }} items</span>
                
                <!-- Column Visibility Dropdown -->
                <div class="col-dropdown">
                    <button onclick="toggleColMenu()" class="px-3 py-2 bg-dark-900 border border-dark-600 text-gray-300 rounded hover:text-white text-sm flex items-center gap-2">
                        <i class="fas fa-columns"></i> Columns <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div class="col-menu" id="colMenu">
                        <!-- Options injected via JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Table Container -->
        <div class="bg-dark-800 border-x border-b border-dark-700 rounded-b-xl overflow-x-auto relative min-h-[400px]">
            <table class="w-full hw-table text-left border-collapse" id="hardwareTable">
                <thead class="bg-dark-900">
                    <tr id="tableHeaderRow">
                        <th class="w-12 text-center sticky left-0 bg-dark-900 z-10 border-r border-dark-700"><input type="checkbox" class="checkbox-custom" id="selectAll" onclick="toggleSelectAll()"></th>
                        <!-- Headers injected via JS -->
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Rows injected via JS -->
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="flex items-center justify-between mt-4 px-2">
            <span class="text-sm text-gray-400" id="pageInfo">Showing 1-10 of {{ records|length }}</span>
            <div class="flex items-center gap-2">
                <button onclick="prevPage()" id="prevBtn" class="px-3 py-1.5 bg-dark-800 border border-dark-600 text-white rounded hover:bg-dark-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm">Previous</button>
                <button onclick="nextPage()" id="nextBtn" class="px-3 py-1.5 bg-dark-800 border border-dark-600 text-white rounded hover:bg-dark-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm">Next</button>
            </div>
        </div>

        {% endif %}
    </div>

    {% if records %}
    <script>
        const rawData = {{ records | tojson }};
        const columns = {{ columns | tojson }} || Object.keys(rawData[0] || {});
        
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredData = [...rawData];
        
        // Track hidden columns by index
        let hiddenColumns = new Set();
        
        // State for Editing
        let editingRowId = null;

        // Initialize Column Menu
        function initColumnMenu() {
            const menu = document.getElementById('colMenu');
            menu.innerHTML = '';
            columns.forEach((col, index) => {
                const label = col.replace(/_/g, ' ').toUpperCase();
                const div = document.createElement('div');
                div.className = 'col-option';
                div.innerHTML = `<input type="checkbox" checked onchange="toggleColumn(${index}, this.checked)"> <span>${label}</span>`;
                menu.appendChild(div);
            });
        }

        function toggleColMenu() { document.getElementById('colMenu').classList.toggle('open'); }
        window.addEventListener('click', function(e) {
            if (!e.target.closest('.col-dropdown')) document.getElementById('colMenu').classList.remove('open');
            // Close all action menus if clicking elsewhere
            if (!e.target.closest('.action-btn') && !e.target.closest('.action-menu')) {
                document.querySelectorAll('.action-menu').forEach(el => el.classList.remove('open'));
            }
        });

        function toggleColumn(index, isVisible) {
            if (isVisible) hiddenColumns.delete(index);
            else hiddenColumns.add(index);
            renderTable();
        }

        function renderHeaders() {
            const row = document.getElementById('tableHeaderRow');
            row.innerHTML = '<th class="w-12 text-center sticky left-0 bg-dark-900 z-10 border-r border-dark-700"><input type="checkbox" class="checkbox-custom" id="selectAll" onclick="toggleSelectAll()"></th>';
            columns.forEach((col, index) => {
                const th = document.createElement('th');
                th.innerText = col.replace(/_/g, ' ');
                if (hiddenColumns.has(index)) th.classList.add('hidden-col');
                row.appendChild(th);
            });
            const actionTh = document.createElement('th');
            actionTh.className = 'w-10';
            row.appendChild(actionTh);
        }

        function renderTable() {
            renderHeaders();
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageItems = filteredData.slice(start, end);

            if (pageItems.length === 0) {
                const colSpan = columns.length + 2;
                tbody.innerHTML = `<tr><td colspan="${colSpan}" class="text-center py-8 text-gray-500 italic">No matching records found</td></tr>`;
                return;
            }

            pageItems.forEach((row, idx) => {
                // Real index in filteredData
                const globalIndex = start + idx;
                
                const tr = document.createElement('tr');
                tr.id = `row-${globalIndex}`;
                
                // --- EDIT MODE RENDER ---
                if (editingRowId === globalIndex) {
                    let cellsHtml = `<td class="text-center sticky left-0 bg-dark-800 z-10 border-r border-dark-700"><input type="checkbox" class="checkbox-custom row-checkbox" disabled></td>`;
                    columns.forEach((col, index) => {
                        const val = row[col] || '';
                        const hiddenClass = hiddenColumns.has(index) ? 'hidden-col' : '';
                        cellsHtml += `<td class="${hiddenClass}"><input type="text" class="edit-input" name="${col}" value="${val}"></td>`;
                    });
                    cellsHtml += `<td class="text-right flex gap-2 pr-2 pt-3">
                        <button onclick="saveRow(${globalIndex})" class="text-green-500 hover:text-green-400"><i class="fas fa-check"></i></button>
                        <button onclick="cancelEdit()" class="text-red-500 hover:text-red-400"><i class="fas fa-times"></i></button>
                    </td>`;
                    tr.innerHTML = cellsHtml;
                } 
                // --- READ MODE RENDER ---
                else {
                    let cellsHtml = `<td class="text-center sticky left-0 bg-dark-800 z-10 border-r border-dark-700"><input type="checkbox" class="checkbox-custom row-checkbox"></td>`;
                    columns.forEach((col, index) => {
                        const val = row[col] || '-';
                        const hiddenClass = hiddenColumns.has(index) ? 'hidden-col' : '';
                        cellsHtml += `<td class="${hiddenClass}">${val}</td>`;
                    });

                    cellsHtml += `
                        <td class="text-right relative">
                            <button onclick="toggleActionMenu(${globalIndex})" class="action-btn text-gray-500 hover:text-white"><i class="fas fa-ellipsis-v"></i></button>
                            <div id="menu-${globalIndex}" class="action-menu">
                                <div class="action-item" onclick="editRow(${globalIndex})"><i class="fas fa-edit"></i> Edit</div>
                                <div class="action-item delete" onclick="deleteRow(${globalIndex})"><i class="fas fa-trash-alt"></i> Delete</div>
                            </div>
                        </td>`;
                    tr.innerHTML = cellsHtml;
                }
                tbody.appendChild(tr);
            });

            // Pagination Update
            const totalItems = filteredData.length;
            const startDisplay = totalItems === 0 ? 0 : start + 1;
            const endDisplay = Math.min(end, totalItems);
            document.getElementById('pageInfo').innerText = `Showing ${startDisplay}-${endDisplay} of ${totalItems}`;
            document.getElementById('recordCount').innerText = `${totalItems} items`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage >= Math.ceil(totalItems / itemsPerPage);
        }

        // Actions
        function toggleActionMenu(index) {
            const menu = document.getElementById(`menu-${index}`);
            const allMenus = document.querySelectorAll('.action-menu');
            allMenus.forEach(m => {
                if (m !== menu) m.classList.remove('open');
            });
            menu.classList.toggle('open');
        }

        function editRow(index) {
            editingRowId = index;
            renderTable();
        }

        function cancelEdit() {
            editingRowId = null;
            renderTable();
        }

        async function saveRow(index) {
            const rowEl = document.getElementById(`row-${index}`);
            const inputs = rowEl.querySelectorAll('input.edit-input');
            const newData = {};
            
            inputs.forEach(input => {
                newData[input.name] = input.value;
            });

            // Optimistic UI Update
            filteredData[index] = { ...filteredData[index], ...newData };
            
            // Send to backend
            try {
                const response = await fetch('/update_hardware_row', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index: index, data: newData })
                });
                
                if (response.ok) {
                    editingRowId = null;
                    renderTable();
                } else {
                    alert("Failed to save changes.");
                }
            } catch (error) {
                console.error(error);
                alert("Network error while saving.");
            }
        }

        async function deleteRow(index) {
            if (!confirm("Are you sure you want to delete this row?")) return;

            try {
                const response = await fetch('/delete_hardware_row', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index: index })
                });

                if (response.ok) {
                    // Remove from local array
                    filteredData.splice(index, 1);
                    // Adjust rawData reference if filtering isn't complex
                    // For simplicity in this view-only filter
                    renderTable();
                } else {
                    alert("Failed to delete row.");
                }
            } catch (error) {
                console.error(error);
                alert("Network error while deleting.");
            }
        }

        // ... [Keep existing search and pagination functions] ...
        function applySearch() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            filteredData = rawData.filter(row => {
                return Object.values(row).some(val => String(val).toLowerCase().includes(term));
            });
            currentPage = 1;
            renderTable();
        }
        function prevPage() { if (currentPage > 1) { currentPage--; renderTable(); } }
        function nextPage() { if (currentPage < Math.ceil(filteredData.length / itemsPerPage)) { currentPage++; renderTable(); } }
        function toggleSelectAll() {
            const master = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => cb.checked = master.checked);
        }

        initColumnMenu();
        renderTable();
    </script>
    {% endif %}

</body>
</html>